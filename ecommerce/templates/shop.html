{% extends 'master.html' %}
{% load static %}
{% block title %}Shop | Bakeora{% endblock %}

{% block content %}

<section class="shop-page mt-5">
  <div class="container">

    <!-- SECTION TITLE -->
    <div class="text-center">
      <h2 class="cakes-section-title">
        Shop Our Delights
        <span class="cakes-title-divider"></span>
      </h2>
      <p class="cakes-section-subtitle">
        Explore everything freshly baked at Bakeora
      </p>
    </div>

    <!-- FILTER BAR -->
    <section class="cakes-filter-bar">
        <form method="get" class="cakes-filter-inner" id="filterForm">

          <select name="type" class="cakes-filter">
            <option value="" hidden>Product Type</option>
            <option value="cake" {% if selected_type == 'cake' %}selected{% endif %}>Cakes</option>
            <option value="dessert" {% if selected_type == 'dessert' %}selected{% endif %}>Desserts</option>
            <option value="pudding" {% if selected_type == 'pudding' %}selected{% endif %}>Puddings</option>
          </select>

          <select name="price" class="cakes-filter">
            <option value="" hidden>Price</option>

            <option value="under-500" {% if selected_price == 'under-500' %}selected{% endif %}>
              Under ₹500
            </option>

            <option value="500-1000" {% if selected_price == '500-1000' %}selected{% endif %}>
              ₹500 – ₹1000
            </option>

            <option value="low-high" {% if selected_price == 'low-high' %}selected{% endif %}>
              Low → High
            </option>

            <option value="high-low" {% if selected_price == 'high-low' %}selected{% endif %}>
              High → Low
            </option>

          </select>

        </form>
    </section>

    <!-- PRODUCTS GRID -->
    <div class="row g-4 mt-4" id="shop-grid">

      {% for item in page_obj %}
      <div class="col-12 col-sm-6 col-lg-3">

        <div class="cake-card">

          {% if item.image %}
          <img src="{{ item.image.url }}" alt="{{ item.name }}">
          {% endif %}

          <div class="cake-info">
            <h5>{{ item.name }}</h5>
            <span>₹{{ item.price }}</span>

            <button class="btn btn-sm add-to-cart-btn"
                    data-product-id="{{ item.id }}">
              Add to Cart
            </button>

          </div>
        </div>

      </div>
      {% empty %}
        <p class="text-center">No products found</p>
      {% endfor %}

    </div>

  </div>
</section>

<!-- PAGINATION -->
{% if page_obj.has_other_pages %}
<div class="pagination-wrap text-center mb-5">
  <ul class="pagination justify-content-center">

    {% if page_obj.has_previous %}
    <li class="page-item">
      <a class="page-link"
         href="?page={{ page_obj.previous_page_number }}&type={{ selected_type }}&price={{ selected_price }}#shop-grid">
         Prev
      </a>
    </li>
    {% else %}
    <li class="page-item disabled"><span class="page-link">Prev</span></li>
    {% endif %}

{% for num in page_obj.paginator.page_range %}
  {% if num <= 3 %}
    {% if page_obj.number == num %}
      <li class="page-item active"><span class="page-link">{{ num }}</span></li>
    {% else %}
      <li class="page-item">
        <a class="page-link"
           href="?{% for key,value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}#shop-grid">
           {{ num }}
        </a>
      </li>
    {% endif %}
  {% endif %}
{% endfor %}

    {% if page_obj.has_next %}
    <li class="page-item">
      <a class="page-link"
         href="?page={{ page_obj.next_page_number }}&type={{ selected_type }}&price={{ selected_price }}#shop-grid">
         Next
      </a>
    </li>
    {% else %}
    <li class="page-item disabled"><span class="page-link">Next</span></li>
    {% endif %}

  </ul>
</div>
{% endif %}

<!-- JS -->
<script>
document.addEventListener("DOMContentLoaded", function () {

  // FILTER AUTO SUBMIT
  document.querySelectorAll('.cakes-filter').forEach(select => {
    select.addEventListener('change', function () {
      const form = document.getElementById("filterForm");
      const data = new FormData(form);
      const url = new URL(window.location.href);

      for (const [k,v] of data.entries()) {
        if (v) url.searchParams.set(k, v);
        else url.searchParams.delete(k);
      }

      url.searchParams.delete("page");
      window.location.href = url.toString();
    });
  });

  // ADD TO CART
  document.querySelectorAll('.add-to-cart-btn').forEach(button => {
    button.addEventListener('click', function () {
      const productId = this.dataset.productId;

      fetch(`/cart/add/${productId}/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": getCookie("csrftoken"),
          "X-Requested-With": "XMLHttpRequest"
        }
      })
      .then(res => res.json())
      .then(data => {
        alert(data.success ? "Added to cart ✅" : "Failed ❌");
      });
    });
  });

});
</script>

{% endblock %}
