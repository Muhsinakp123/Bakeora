{% extends "master.html" %}
{% load static %}

{% block title %}Desserts | Bakeora{% endblock %}

{% block content %}

<!-- ================= LUXURY HERO ================= -->
<section class="dessert-hero-lux">
  <div class="container">
    <div class="dessert-hero-panel">
      <div class="row align-items-center">

        <div class="col-md-6 dessert-hero-left">
          <h1>We Deliver<br>Quality Desserts</h1>
          <p>Indulge in handcrafted delights made with premium ingredients.</p>
        </div>

        <div class="col-md-6 dessert-hero-right">
          <img src="{% static 'images/dessert-hero.png' %}">
        </div>

      </div>
    </div>
  </div>
  <div class="dessert-hero-gold"></div>
</section>


<!-- ================= POPULAR PICKS ================= -->
<section class="dessert-popular-lux py-5">
  <div class="container text-center">
    <h2 class="dessert-section-title">
      Popular Picks
      <span class="dessert-title-divider"></span>
    </h2>
    <p class="dessert-section-subtitle">Our most loved desserts</p>

    <div class="row g-4 mt-4">
      <div class="col-12 col-sm-6 col-lg-4">
        <div class="dessert-gold-frame">
          <div class="dessert-card">
            <img src="{% static 'images/browny.jpg' %}">
            <div class="dessert-card-info">
              <h5>Cheesecake Swirl Brownie</h5>
              <span>₹790</span>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-sm-6 col-lg-4">
        <div class="dessert-gold-frame">
          <div class="dessert-card">
            <img src="{% static 'images/donuts.jpg' %}">
            <div class="dessert-card-info">
              <h5>Donuts</h5>
              <span>₹200</span>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-sm-6 col-lg-4">
        <div class="dessert-gold-frame">
          <div class="dessert-card">
            <img src="{% static 'images/macaroons.jpg' %}">
            <div class="dessert-card-info">
              <h5>Macaroons</h5>
              <span>₹300</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ================= GRID ================= -->
<section id="dessert-grid" class="cakes-grid py-5">
  <div class="container">

    <!-- SECTION TITLE -->
    <div class="text-center ">
      <h2 class="cakes-section-title">
        Available Delights
        <span class="cakes-title-divider"></span>
      </h2>

      <p class="cakes-section-subtitle">
        Explore our freshly prepared dessert collection
      </p>
    </div>
    <!-- ================= FILTER BAR ================= -->
<section class="cakes-filter-bar">
  <div class="container">
    <form method="get" class="cakes-filter-inner" id="filterForm">

      <select name="category" class="cakes-filter">
        <option value="" hidden>Category</option>

        <option value="pastries"
          {% if request.GET.category == 'pastries' %}selected{% endif %}>
          Pastries
        </option>

        <option value="cookies_biscuits"
          {% if request.GET.category == 'cookies_biscuits' %}selected{% endif %}>
          Cookies & Biscuits
        </option>

        <option value="brownie"
          {% if request.GET.category == 'brownie' %}selected{% endif %}>
          Brownie
        </option>

        <option value="pistachio"
          {% if request.GET.category == 'pistachio' %}selected{% endif %}>
          Pistachio
        </option>
      </select>


      <select name="flavor" class="cakes-filter">
        <option value="" hidden>Flavor</option>

        <option value="chocolate"
          {% if request.GET.flavor == 'chocolate' %}selected{% endif %}>
          Chocolate
        </option>

        <option value="vanilla"
          {% if request.GET.flavor == 'vanilla' %}selected{% endif %}>
          Vanilla
        </option>

        <option value="fruit"
          {% if request.GET.flavor == 'fruit' %}selected{% endif %}>
          Fruit
        </option>

        <option value="nutty_caramel"
          {% if request.GET.flavor == 'nutty_caramel' %}selected{% endif %}>
          Nutty & Caramel
        </option>
      </select>


      <select name="price" class="cakes-filter">
        <option value="" hidden>Price</option>

        <option value="low-high"
          {% if request.GET.price == 'low-high' %}selected{% endif %}>
          Low → High
        </option>

        <option value="high-low"
          {% if request.GET.price == 'high-low' %}selected{% endif %}>
          High → Low
        </option>
      </select>

    </form>
  </div>
</section>


    <div class="row g-4">

      {% for dessert in page_obj %}
      <div class="col-12 col-sm-6 col-lg-3">
        <div class="cake-card">
          <img src="{{ dessert.image.url }}" alt="{{ dessert.name }}">

          <div class="cake-info">
            <h5>{{ dessert.name }}</h5>
            <span>₹{{ dessert.price }}</span>

{% if dessert.ps %}
<button class="btn btn-sm add-to-cart-btn"
        data-product-id="{{ dessert.ps.id }}">
  Add to Cart
</button>
{% else %}
<span class="text-danger">Unavailable</span>
{% endif %}


          </div>
        </div>
      </div>
      {% empty %}
      <p class="text-center">No desserts found</p>
      {% endfor %}

    </div>
  </div>
</section>


<!-- ================= PAGINATION ================= -->
<div class="pagination-wrap mb-5">
  <ul class="pagination justify-content-center">

    {% if page_obj.has_previous %}
    <li class="page-item">
      <a class="page-link"
        href="?{% for k,v in request.GET.items %}{% if k != 'page' %}{{ k }}={{ v }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}#dessert-grid">
        Previous
      </a>
    </li>
    {% endif %}

{% for num in page_obj.paginator.page_range %}
  {% if num <= 3 %}
    {% if page_obj.number == num %}
      <li class="page-item active">
        <span class="page-link">{{ num }}</span>
      </li>
    {% else %}
      <li class="page-item">
        <a class="page-link"
           href="?{% for key,value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}#dessert-grid">
           {{ num }}
        </a>
      </li>
    {% endif %}
  {% endif %}
{% endfor %}


    {% if page_obj.has_next %}
    <li class="page-item">
      <a class="page-link"
        href="?{% for k,v in request.GET.items %}{% if k != 'page' %}{{ k }}={{ v }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}#dessert-grid">
        Next
      </a>
    </li>
    {% endif %}

  </ul>
</div>


<!-- ================= JS ================= -->
<script>
document.addEventListener("DOMContentLoaded", function () {

  // ===== ADD TO CART =====
  document.querySelectorAll('.add-to-cart-btn').forEach(button => {
    button.addEventListener('click', function () {
      const productId = this.dataset.productId;

      fetch(`/cart/add/${productId}/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": getCookie("csrftoken"),
          "X-Requested-With": "XMLHttpRequest"
        }
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) alert("Added to cart ✅");
        else alert("Failed ❌");
      });
    });
  });

  // ===== FILTER AUTO SUBMIT + SCROLL TARGET =====
  const filterForm = document.getElementById("filterForm");

  document.querySelectorAll("#filterForm select").forEach(select => {
    select.addEventListener("change", () => {
      const params = new URLSearchParams(new FormData(filterForm));
      window.location = "?" + params.toString() + "#dessert-grid";
    });
  });

});
</script>

{% endblock %}
