{% extends "master.html" %}
{% load static %}

{% block title %}Cakes | Bakeora{% endblock %}

{% block content %}

<!-- ================= HERO HEADER ================= -->
<section class="cakes-hero">
  <div class="cakes-hero-overlay">
    <div class="container">
      <div class="cakes-hero-text">
        <h1>Signature Creations</h1>
        <p>Handcrafted cakes for every celebration</p>
        <a href="{% url 'custom_order' %}" class="btn btn-lg mt-3 order-btn">Custom Order</a>
      </div>
    </div>
  </div>
</section>

<!-- ================= BEST SELLERS ================= -->
<section class="cakes-best-sellers">
  <div class="container">
    <h2 class="cakes-section-title">Best Sellers</h2>
    <p class="cakes-section-subtitle">Our most loved cakes, chosen by customers</p>

    <div class="row g-4 mt-4">
      <!-- Cake Cards -->
      <div class="col-12 col-sm-6 col-lg-3">
        <div class="best-seller-card">
          <img src="{% static 'images/ctc.jpg' %}" alt="Chocolate Truffle Cake">
          <div class="best-seller-info">
            <h5>Chocolate Truffle</h5>
            <span>₹1,250</span>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-3">
        <div class="best-seller-card">
          <img src="{% static 'images/rvc.jpg' %}" alt="Red Velvet Cake">
          <div class="best-seller-info">
            <h5>Red Velvet</h5>
            <span>₹1,150</span>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-3">
        <div class="best-seller-card">
          <img src="{% static 'images/floral.jpg' %}" alt="Floral Wedding Cake">
          <div class="best-seller-info">
            <h5>Floral Wedding Cake</h5>
            <span>₹3,500</span>
          </div>
        </div>
      </div>
      <div class="col-12 col-sm-6 col-lg-3">
        <div class="best-seller-card">
          <img src="{% static 'images/lbc.jpg' %}" alt="Lemon Blueberry Cake">
          <div class="best-seller-info">
            <h5>Lemon Blueberry</h5>
            <span>₹1,300</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ================= CATEGORY BUBBLES ================= -->
<section class="cakes-categories">
  <div class="container">
    <div class="cakes-category-row">
      <a href="?category=wedding" class="cakes-category"><i class="bi bi-heart"></i><span>Wedding</span></a>
      <a href="?category=birthday" class="cakes-category"><i class="bi bi-cake2"></i><span>Birthday</span></a>
      <a href="?category=bento" class="cakes-category"><i class="bi bi-box"></i><span>Bento</span></a>
      <a href="?category=vegan" class="cakes-category"><i class="bi bi-leaf"></i><span>Vegan</span></a>
      <a href="?category=kids" class="cakes-category"><i class="bi bi-emoji-smile"></i><span>Kids</span></a>
    </div>
  </div>
</section>

<!-- ================= STICKY FILTER BAR ================= -->
<section class="cakes-filter-bar">
  <div class="container">
    <form method="get" class="cakes-filter-inner">
      {% if request.GET.category %}
        <input type="hidden" name="category" value="{{ request.GET.category }}">
      {% endif %}

      <!-- Flavor Filter -->
      <select name="flavor" class="cakes-filter" onchange="this.form.submit()">
        <option value="" hidden>Flavor</option>
        <option value="chocolate" {% if request.GET.flavor == 'chocolate' %}selected{% endif %}>Chocolate</option>
        <option value="vanilla" {% if request.GET.flavor == 'vanilla' %}selected{% endif %}>Vanilla</option>
        <option value="red-velvet" {% if request.GET.flavor == 'red-velvet' %}selected{% endif %}>Red Velvet</option>
        <option value="butterscotch" {% if request.GET.flavor == 'butterscotch' %}selected{% endif %}>Butterscotch</option>
        <option value="fruit-cakes" {% if request.GET.flavor == 'fruit-cakes' %}selected{% endif %}>Fruit Cakes</option>
        <option value="cheese_cakes" {% if request.GET.flavor == 'cheese_cakes' %}selected{% endif %}>Cheese Cakes</option>
      </select>

      <!-- Structure Filter -->
      <select name="structure" class="cakes-filter" onchange="this.form.submit()">
        <option value="" hidden>Structure</option>
        <option value="single" {% if request.GET.structure == 'single' %}selected{% endif %}>Single Tier</option>
        <option value="double" {% if request.GET.structure == 'double' %}selected{% endif %}>Double Tier</option>
        <option value="cupcakes" {% if request.GET.structure == 'cupcakes' %}selected{% endif %}>Cup Cakes</option>
        <option value="sheetcakes" {% if request.GET.structure == 'sheetcakes' %}selected{% endif %}>Sheet Cakes</option>
        <option value="spongecakes" {% if request.GET.structure == 'spongecakes' %}selected{% endif %}>Sponge Cakes</option>
        <option value="themecakes" {% if request.GET.structure == 'themecakes' %}selected{% endif %}>Theme Cakes</option>
      </select>

      <!-- Price Filter -->
      <select name="price" class="cakes-filter" onchange="this.form.submit()">
        <option value="" hidden>Price</option>
        <option value="300-600" {% if request.GET.price == '300-600' %}selected{% endif %}>₹300 – ₹600</option>
        <option value="500-1000" {% if request.GET.price == '500-1000' %}selected{% endif %}>₹500 – ₹1000</option>
        <option value="1000-1500" {% if request.GET.price == '1000-1500' %}selected{% endif %}>₹1000 – ₹1500</option>
        <option value="low-high" {% if request.GET.price == 'low-high' %}selected{% endif %}>Low → High</option>
        <option value="high-low" {% if request.GET.price == 'high-low' %}selected{% endif %}>High → Low</option>
      </select>
    </form>
  </div>
</section>

<!-- ================= CAKE GRID ================= -->
<section class="cakes-grid">
  <div class="container">
    <div class="row g-4">
      {% for cake in page_obj %}
      <div class="col-12 col-sm-6 col-lg-3">
        <div class="cake-card">
          <a href="{% url 'cake_detail' cake.id %}">
            <img src="{{ cake.image.url }}" alt="{{ cake.name }}">
          </a>
          <div class="cake-info">
            <a href="{% url 'cake_detail' cake.id %}"><h5>{{ cake.name }}</h5></a>
            <span>₹{{ cake.price }}</span>
            <button class="btn btn-sm add-to-cart-btn" data-product-id="{{ cake.id }}">Add to Cart</button>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</section>

<!-- ================= PAGINATION ================= -->
<div class="pagination-wrap">
  <ul class="pagination justify-content-center">
    {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?{% for key,value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}">Previous</a>
      </li>
    {% endif %}

    {% for num in page_obj.paginator.page_range %}
      <li class="page-item {% if page_obj.number == num %}active{% endif %}">
        <a class="page-link" href="?{% for key,value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}">{{ num }}</a>
      </li>
    {% endfor %}

    {% if page_obj.has_next %}
      <li class="page-item">
        <a class="page-link" href="?{% for key,value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}">Next</a>
      </li>
    {% endif %}
  </ul>
</div>

<script>
  document.querySelectorAll('.add-to-cart-btn').forEach(button => {
    button.addEventListener('click', function () {
      const productId = this.dataset.productId;

      fetch(`/cart/add/${productId}/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
          "X-Requested-With": "XMLHttpRequest"
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert("Added to cart ✅");
        } else {
          alert("Failed to add to cart ❌");
        }
      })
      .catch(error => console.error("Error:", error));
    });
  });
</script>

{% endblock %}
